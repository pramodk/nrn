

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Mac Binary Package (Apple M1 and Mac x86_64) &mdash; NEURON  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NEURON Python documentation" href="../python/index.html" />
    <link rel="prev" title="Code Coverage" href="code_coverage.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> NEURON
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Building:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cmake_doc/index.html">CMake Build Options</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="developer.html">Developer Builds</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="code_coverage.html">Code Coverage</a></li>
<li class="toctree-l2"><a class="reference internal" href="code_coverage.html#simplified-workflow">Simplified Workflow</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Mac Binary Package (Apple M1 and Mac x86_64)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#dependencies">Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#signing-and-notarization">Signing and Notarization</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">User documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python/index.html">NEURON Python documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hoc/index.html">NEURON HOC documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Python tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rxd-tutorials/index.html">Python RXD tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../coreneuron/index.html">How to use CoreNEURON</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../scm/index.html">NEURON SCM and Release</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev/index.html">NEURON Development topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doxygen.html">C/C++ API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NEURON</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="developer.html">Developer Builds</a> &raquo;</li>
        
      <li>Mac Binary Package (Apple M1 and Mac x86_64)</li>
    
    
<li class="wy-breadcrumbs-aside">
    
    
</li>

      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/install/mac_pkg.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    

  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mac-binary-package-apple-m1-and-mac-x86-64">
<h1>Mac Binary Package (Apple M1 and Mac x86_64)<a class="headerlink" href="#mac-binary-package-apple-m1-and-mac-x86-64" title="Permalink to this headline">¶</a></h1>
<p>Binary packages are built with the <code class="docutils literal notranslate"><span class="pre">nrnmacpkgcmake.sh</span></code> script which,
near the end of its operation,
involves code signing, package signing, and notarization.
Preparing your Mac development environment for correct functioning of
the script requires installing a few extra <a class="reference external" href="#Dependencies">Dependencies</a> beyond the
<a class="reference external" href="./install_instructions.html#Mac-OS-Depend">normal user source build</a>, obtaining an Apple Developer Program membership,
and requesting two signing certificates from Apple. Those actions are
described in separate sections below.
On an Apple M1,
the script, by default, creates, e.g.,
<code class="docutils literal notranslate"><span class="pre">nrn-8.0a-427-g1a80b2cc-osx-arm64-py-38-39.pkg</span></code>
where the information between nrn and osx comes from <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">describe</span></code>
and the numbers after the py indicate the python versions that are
compatible with this package. Those python versions must be installed on
the developer machine. On a Mac x86_64 architecture the script, by default,
creates, e.g., <code class="docutils literal notranslate"><span class="pre">nrn-8.0a-427-g1a80b2cc-osx-x86_64-py-27-36-37-38-39.pkg</span></code></p>
<p>A space separated list of python executable arguments can be used in
place of the internal default lists. <code class="docutils literal notranslate"><span class="pre">$NRN_SRC</span></code> is the location of the
repository, default <code class="docutils literal notranslate"><span class="pre">$HOME/neuron/nrn</span></code>. The script makes sure <code class="docutils literal notranslate"><span class="pre">$NRN_SRC/build</span></code>
exists and uses that folder to configure and build the software. The
software is installed in <code class="docutils literal notranslate"><span class="pre">/Applications/NEURON</span></code>.</p>
<p>At time of writing, the cmake
command in the script that is used to configure the build is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cmake .. -DCMAKE_INSTALL_PREFIX=$NRN_INSTALL \
  -DNRN_ENABLE_MPI_DYNAMIC=ON \ 
  -DPYTHON_EXECUTABLE=`which python3` -DNRN_ENABLE_PYTHON_DYNAMIC=ON \
  -DNRN_PYTHON_DYNAMIC=&quot;$pythons&quot; \
  -DIV_ENABLE_X11_DYNAMIC=ON \
  -DNRN_ENABLE_CORENEURON=OFF \
  -DNRN_ENABLE_INTERNAL_READLINE=ON \
  -DNRN_RX3D_OPT_LEVEL=2 \
  -DCMAKE_OSX_ARCHITECTURES=&quot;$CPU&quot; \
  -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++
</pre></div>
</div>
<p>A universal build is possible with <code class="docutils literal notranslate"><span class="pre">-DCMAKE_OSX_ARCHITECTURES=&quot;arm64;x86_64&quot;</span></code>
but the installations for openmpi and python on your machine must also be universal.
I.e. configure with <code class="docutils literal notranslate"><span class="pre">-DNRN_ENABLE_MPI_DYNAMIC=OFF</span> <span class="pre">-DNRN_PYTHON_DYNAMIC=/usr/bin/python3</span></code>.
As we have been unable to find or build a universal openmpi, and
only the Big Sur default Python 3.8 installaion is universal, we are
currently building separate installers for arm64 and x86_64.</p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">-j</span> <span class="pre">install</span></code> is used to build and install in <code class="docutils literal notranslate"><span class="pre">/Applications/NEURON</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">macpkg</span></code> ( see <code class="docutils literal notranslate"><span class="pre">src/mac/CMakeLists.txt</span></code> ) is used to:</p>
<ul class="simple">
<li>activate the apps <code class="docutils literal notranslate"><span class="pre">src/mac/activate-apps-cmake.sh</span></code></li>
<li>codesign all the binaries <code class="docutils literal notranslate"><span class="pre">src/mac/nrn_codesign.sh</span></code>:<ul>
<li>Codesigning all binaries in the package is a prerequisite for
notarization and not necessary if the package is not notarized. In
that case it is a bit more trouble for users to install as they must
ignore the scary message that pops up before the installer
and know to right click on that message, then
click <code class="docutils literal notranslate"><span class="pre">Open</span></code>. Then accept the option to <code class="docutils literal notranslate"><span class="pre">Open</span></code> the installer.</li>
<li>To prevent Notarization failure the binaries need hardened runtime enabled
and then some of the binaries need some special entitlements enabled.
These entitlements are specified in <code class="docutils literal notranslate"><span class="pre">src/mac/nrn_entitlements.plist</span></code>
and allow use of the Apple Events, Just in time compilation, and
disable library validation.  The user will be asked to accept the
first time these entitlements are invoked.</li>
</ul>
</li>
<li>create NEURON.pkg . <code class="docutils literal notranslate"><span class="pre">/usr/bin/packagesbuild</span></code> uses <code class="docutils literal notranslate"><span class="pre">src/mac/macdist/pkgproj.in</span></code></li>
<li>productsign NEURON.pkg <code class="docutils literal notranslate"><span class="pre">src/mac/nrn_productsign.sh</span></code></li>
<li>request Apple to notarize NEURON.pkg <code class="docutils literal notranslate"><span class="pre">src/macnrn_notarize.sh</span></code></li>
</ul>
<p>The script ends by printing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  Until we figure out how to automatically staple the notarization
  the following two commands must be executed manually.
  xcrun stapler staple $PACKAGE_FILE_NAME
  cp $PACKAGE_FILE_NAME $HOME/$PACKAGE_FULL_NAME
</pre></div>
</div>
<p>where the variables are filled out and can be copy/pasted to your
terminal after Apple sends an email declaring that notarization was successful.</p>
<p>The email from Apple usually takes just a few minutes but can be hours.
I’ve been uploading the <code class="docutils literal notranslate"><span class="pre">$PACKAGE_FULL_NAME</span></code> as an artifact for a
Release version from https://github.com/neuronsimulatior/nrn by choosing
Releases, choosing the proper Release tag (e.g. Release 8.0a), Edit release,
and clicking in the “Attach binaries …” near the bottom of the page.</p>
<p><a name="Dependencies"></a></p>
<div class="section" id="dependencies">
<h2>Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h2>
<p>This uses Apple M1 as the example but mostly the same for an x86_64 mac.
<code class="docutils literal notranslate"><span class="pre">lipo</span></code> tells what architecture a binary must be run on. For example,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lipo -archs `which python3`
x86_64 arm64
</pre></div>
</div>
<p>which is generally the case for all Big Sur mac software. On the other
hand, <code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">...</span></code> executables and libraries are
generally only for the architecture indicated by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uname</span> <span class="o">-</span><span class="n">m</span>
</pre></div>
</div>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">xcode-select</span> <span class="pre">--install</span></code>:</p>
<ul class="simple">
<li>Sadly, notarization requires <code class="docutils literal notranslate"><span class="pre">altool</span></code> which is not distributed
with the command line tools. So one needs to install the full xcode
(at least version 12) from the App Store. That is very large and may
take an hour or so to download.</li>
</ul>
</li>
<li><p class="first">Install latest <a class="reference external" href="http://xquartz.org">XQuartz</a> release. At least XQuartz-2.8.0_rc1</p>
</li>
<li><p class="first">Install <a class="reference external" href="http://s.sudre.free.fr/Software/Packages/about.html">PackagesBuild</a></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">brew</span> <span class="pre">install</span> <span class="pre">cmake</span> <span class="pre">open-mpi</span> <span class="pre">python3.9</span></code></p>
<ul>
<li><p class="first">Python 3.8 is already installed as /usr/bin/python3</p>
</li>
<li><p class="first">The <a class="reference external" href="./install_instructions.html#Mac-OS-Depend">normal source build</a>
explains how to install brew and add it to the PATH.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/bin/bash -c &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/H$
echo &#39;eval $(/opt/homebrew/bin/brew shellenv)&#39; &gt;&gt; $HOME/.zprofile
eval $(/opt/homebrew/bin/brew shellenv)
</pre></div>
</div>
</li>
<li><p class="first">Both pythons need numpy installed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip3</span><span class="o">.</span><span class="mi">9</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">pip</span>
<span class="n">pip3</span><span class="o">.</span><span class="mi">9</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">numpy</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">upgrade</span> <span class="n">pip</span>
<span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">numpy</span>
</pre></div>
</div>
</li>
<li><p class="first">At least the first python3 in your PATH needs cython installed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">cython</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="signing-and-notarization">
<h2>Signing and Notarization<a class="headerlink" href="#signing-and-notarization" title="Permalink to this headline">¶</a></h2>
<p>Notarization needs a $99/year <a class="reference external" href="https://help.apple.com/developer-account/">Apple Developer Program</a> membership.
Certificates last 5 years.</p>
<p>The most clearly explained recipe for notarization that I found is
<a class="reference external" href="https://www.davidebarranca.com/2019/04/notarizing-installers-for-macos-catalina/">Notarizing installers for macOS Catalina</a>
.</p>
<p>However it took me while to figure out that it takes <a class="reference external" href="https://help.apple.com/developer-account/#/dev04fd06d56">two certificates</a>
from apple.  I.e.  A “developerID_application.cer” to sign all the
binaries before the pkg is built and a “developerID_installer.cer” to
sign the pkg. Certificates can be obtained through Keychain by creating
a <a class="reference external" href="https://help.apple.com/developer-account/#/devbfa00fef7">certificate signing request</a>
On receipt of the certificates, I added to my keychain by clicking on them.</p>
<p>And one must manage an <a class="reference external" href="https://support.apple.com/en-us/HT204397">App specific password</a>
to request notarization from Apple.
I put the password in <code class="docutils literal notranslate"><span class="pre">$HOME/.ssh/notarization-password</span></code> which is where
<code class="docutils literal notranslate"><span class="pre">src/mac/nrn_notarize.sh</span></code> expects it.</p>
<p>Notarization requires that we “enable hardened runtime”
which is done during the binary signing, but that results in issues with
regard to apple events and mismatched, unsigned, and non-system
libraries (as well as preventing JIT compilation).  At this point
<a class="reference external" href="https://forum.xojo.com/t/how-to-add-entitlements-to-a-xojo-app-using-codesign/49735/9">How to add entitlements…</a>
was very helpful with regard to picking
<a class="reference external" href="https://developer.apple.com/documentation/bundleresources/entitlements">entitlements</a>
to develop a nrn_entitlements.plist to relax the strict hardened
runtime.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../python/index.html" class="btn btn-neutral float-right" title="NEURON Python documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="code_coverage.html" class="btn btn-neutral float-left" title="Code Coverage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Duke, Yale and the Blue Brain Project.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>